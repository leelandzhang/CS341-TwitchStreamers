---
title: "SNAP-ERGM"
author: "Murat Sankaya"
date: today
execute:
  echo: false
format: 
  pdf:
      output-file: "ergm_murat_sankaya"
      output-ext: "pdf"
      toc: true
      toc-depth: 4
      shift-heading-level-by: 2
      fig-pos: "H"
      fig-cap-location: top
      geometry:
        - top=1in
        - right=.8in
        - bottom=1in
        - left=.8in
      link-citations: true
      linkcolor: blue
      include-in-header: 
        text: |
          \usepackage{fancyhdr}
          \usepackage{titling}
          \pagestyle{fancy}
          \fancyhf{}
          \renewcommand\maketitle{
            \fancyhead[C]{
              \thetitle
              \ifx \theauthor\empty  \else \ – \theauthor \fi
              \ifx \thedate\empty  \else \ – \thedate \ \fi
            }
          }
          \fancyfoot[C]{\thepage}
---



```{r}
#| echo: false
#| output: false
#| message: false

# Exponential Random Graph Model (ERGM)

# Clear your environment
rm(list=ls())

# Install packages below if you do not have them:
# -------------------------------------------------
if (!"statnet" %in% installed.packages()) install.packages("statnet") # For fitting ERGMs
if (!"igraph" %in% installed.packages()) install.packages("igraph") # For network plotting
if (!"texreg" %in% installed.packages()) install.packages("texreg") # For printing "nicer" model output

```

# Part I: Building and Visualizing the Networks

The analysis will be using 2 types of files: "filtered_twitch_edges.csv" as the *base_network* and "filtered_twitch_features.csv" will make up the *node_attributes*. 

```{r}
#| echo: false
#| output: false
#| message: false

######################## PART I: Building and Visualizing the Networks ########################
# ----------------------------------------------------------------------------------------------------
# Dependent variable:
# “Mutual follower relationship of Twitch Users.” 

# Load the edge list and features
mutualEdgelist <- read.csv("mapped_twitch_edges.csv")
features <- read.csv("mapped_twitch_features.csv")

# Get all unique node IDs from features file
all_nodes <- features$numeric_id

# Create an empty network with all nodes
mutual <- network.initialize(length(all_nodes), directed = FALSE)

# Add edges
add.edges(mutual, mutualEdgelist$numeric_id_1, mutualEdgelist$numeric_id_2)

# View the summary of the network object
mutual

# Independent variables:
# Load node attributes, and store them in the mutual network object we have created
mutual |> network::set.vertex.attribute("descaled_views", 
                          value = features$views / 10000) # Attribute indicating how many views has the streamer received

mutual |> network::set.vertex.attribute("mature",features$mature) # Attribute indicating whether the streamer creates "mature" content
mutual |> network::set.vertex.attribute("life_time",features$life_time) # The time between the streamer creating the account and the last time they have uploaded content. As of 2018. 

mutual |> network::set.vertex.attribute("dead_account",features$dead_account) # Indicator variable for inactive accounts

mutual |> network::set.vertex.attribute("language",features$language) # Categorical variable for the main language used within the account

mutual |> network::set.vertex.attribute("affiliate",features$affiliate) # Indicating any affliation of user

mutual # These five variables should now be listed as vertex attributes when viewing the summary of the network
```


```{r}
# Double-check the values for all of the node variables
network::get.vertex.attribute(mutual,"descaled_views")
network::get.vertex.attribute(mutual,"mature")
network::get.vertex.attribute(mutual,"life_time")
network::get.vertex.attribute(mutual,"dead_account")
network::get.vertex.attribute(mutual,"language")
network::get.vertex.attribute(mutual,"affiliate")

```


## 1. Plotting the mutual followers network.

```{r}
# ----------------------------------------------------------------------------
# Visualize networks
# ----------------------------------------------------------------------------
library('igraph') # Ignore messages on any objects that are masked

# TO-DO: Will continue on this if time permits

```

# Part II: Model Estimation 

```{r}
# ----------------------------------------------------------------------------
######################## PART II: Build the ERGM models ########################
#
# R vignette for more details: https://cran.r-project.org/web/packages/ergm/ergm.pdf
# ----------------------------------------------------------------------------
detach(package:igraph) # Remove the 'igraph' package from your environment. 
library(statnet)
options(ergm.loglik.warn_dyads=FALSE) # Whether or not a warning should be issued when sample space constraints render the observed number of dyads ill-defined
help("ergm-terms",package = "ergm")
```

```{r}
#| message: false

# The following commands do model estimation for ERGMs.
# This may take a second. Text will print in-console to update you on progress in model estimation.
model1 <- ergm(mutual ~ edges # Captures the tendency of nodes with many edges forming more mutual connections
               + nodematch("mature") # Homophily effect on the categorical variable "mature"
               + nodematch("affiliate") # Homophily effect on the categorical variable "affiliate"
               + nodematch("language") # Homophily effect on the categorical variable "language"
               + nodecov("descaled_views")  # Effect of the number of descaled views on the likelihood of forming an edge         
               + nodecov("life_time") # Effect of the lifetime of an account on the likelihood of forming an edge 
               , control = control.ergm(seed = 42)
               , verbose = F
)
summary(model1) 

```
